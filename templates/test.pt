<html>
  <head>
    <script language="JavaScript" type="text/javascript" src="Presentation/Tofu/Ajax/js/dojo/dojo.js"></script>
    <script language="JavaScript" type="text/javascript">
    lastTimestamp = null;
    function cb_timeout() {
        do_bind();
    };
    function populate_messages( type, data, event, kwArgs ) {
        chatMessages = document.getElementById('chatmessages');
        chatMessages.innerHTML = "";
        for (var x = 0; x &lt;= data.length-1; x++)
        {
           msgDiv = document.createElement("div");
           msgDiv.innerHTML = data[x]['message']
           msgDiv.className = 'message';
           timeDiv = document.createElement("div");
           timeDiv.innerHTML = data[x]['timestamp']
           timeDiv.className = 'timestamp';
           document.getElementById('chatmessages').appendChild(timeDiv);
           document.getElementById('chatmessages').appendChild(msgDiv);
        }
        if (data.length &gt; 0) {
           lastTimestamp = data[0]['timestamp'];	
        }
        
    };
    function cb_chat( type, data, event, kwArgs ) {
        delay = 10000;
        populate_messages( type, data, event, kwArgs);    
        tid = window.setTimeout( "cb_timeout()", delay /* milliseconds */);    
    };
    function do_bind () {
        dojo.io.bind({
	url: "http://groupserver:8080/example_division/cb_chat",
	load: cb_chat,
        mimetype: "text/json",
        content: {'group_id': 'foo', 'last_timestamp': lastTimestamp},
	error: function(type, data, event, kwArgs) { 
             alert('error');/* type will be "error", data will be response data,  event will null, and kwArgs are the keyword arguments used in the dojo.io.bind call. */ },
	timeout: function() { alert('timeout'); /* Called if there is a timeout */},
	timeoutSeconds: 10, //The number of seconds to wait until firing timeout callback in case of timeout.
        preventCache: true
        }); 
    }
    do_bind();

    function chatForm() {
      var x = new dojo.io.FormBind({
      formNode: document.getElementById('chat_form'),
      mimetype: 'text/json',
      load: populate_messages
      });
    }
	
    dojo.addOnLoad(chatForm);

    </script>
    <title tal:content="template/title">The title</title>
  </head>
  <body>
    
    <h2>Richard's Seriously Simple AJAX Chat</h2>

    Response:
  
       <div id="chatmessages"></div>

    Send stuff:
      <form id="chat_form" method="POST" action="http://groupserver:8080/example_division/submit_message">
          <input type="hidden" name="group_id" value="foo" />
          <input type="text" name="message" value="" />
          <input type="submit" name="submit" value="send" />
      </form>

  </body>
</html>
